<div class="app-shell">
  <header>
    <h1>{{ title() }}</h1>
    <button (click)="fetchProjects()" aria-label="Refresh projects">↻ Refresh</button>
  </header>
  <section class="layout">
    <aside>
      <h2>Projects</h2>
      <details class="create-form" open>
        <summary>Create Project</summary>
        <form (submit)="createProject($event)" novalidate>
          <label>
            Name
            <input name="name" required (input)="onNameInput($any($event.target).value)" />
            <small class="hint" *ngIf="newProjectSlug()"
              >Slug: <code>{{ newProjectSlug() }}</code></small
            >
          </label>
          <label class="wide">
            Description
            <textarea
              name="description"
              rows="2"
              placeholder="Short summary / objective"
            ></textarea>
          </label>
          <label>
            Domain
            <input name="domain" placeholder="e.g. claims, billing" />
          </label>
          <label>
            Owner
            <input name="owner" placeholder="team or person" />
          </label>
          <label>
            Priority
            <input name="priority" placeholder="High / Medium / Low" />
          </label>
          <label class="wide">
            Tags (comma separated)
            <input
              name="tags"
              placeholder="tag1, tag2"
              (input)="onTagsInput($any($event.target).value)"
            />
            <div class="chips" *ngIf="tagChips().length">
              <span class="chip" *ngFor="let t of tagChips()">{{ t }}</span>
            </div>
          </label>
          <button type="submit" [disabled]="creatingProject() || !newProjectSlug()">
            {{ creatingProject() ? 'Creating…' : 'Create' }}
          </button>
        </form>
      </details>
      <div *ngIf="loadingProjects()">Loading projects…</div>
      <ul>
        <li *ngFor="let p of projects()" [class.active]="p.slug === selectedProject()?.slug">
          <button (click)="selectProject(p)">{{ p.name || p.slug }}</button>
        </li>
      </ul>
    </aside>
    <main>
      <section *ngIf="selectedProject() as proj">
        <h2>Initiatives – {{ proj.slug }}</h2>
        <div *ngIf="loadingRuns()">Loading initiatives…</div>
        <ul class="runs">
          <li *ngFor="let r of runs()" [class.active]="r.run_id === selectedRun()?.run_id">
            <button (click)="selectRun(r)">{{ runLabel(r) }}</button>
          </li>
        </ul>
        <form class="create-run" (submit)="createRun($event)" *ngIf="!loadingRuns()" novalidate>
          <input name="initiative" placeholder="Describe a new initiative focus" />
          <button type="submit">Generate Initiative</button>
        </form>
        <div *ngIf="!loadingRuns() && !runs().length" class="empty">
          No initiatives yet. Generate the first one.
        </div>
      </section>

      <section *ngIf="selectedRun() as run">
        <h2>Initiative Plan</h2>
        <details class="diff-panel" *ngIf="runs().length > 1">
          <summary>Plan Diff</summary>
          <form (submit)="computeDiff($event)" class="diff-form">
            <label>
              Old
              <select [value]="diffOldRun() || ''" (change)="diffOldRun.set($any($event.target).value)">
                <option value="" disabled>Select</option>
                <option *ngFor="let r of runs()" [value]="r.run_id">{{ runLabel(r) }}</option>
              </select>
            </label>
            <label>
              New
              <select [value]="diffNewRun() || ''" (change)="diffNewRun.set($any($event.target).value)">
                <option value="" disabled>Select</option>
                <option *ngFor="let r of runs()" [value]="r.run_id">{{ runLabel(r) }}</option>
              </select>
            </label>
            <button type="submit" [disabled]="diffLoading() || !diffOldRun() || !diffNewRun()">
              {{ diffLoading() ? 'Computing…' : 'Diff' }}
            </button>
          </form>
          <div class="diff-result" *ngIf="planDiff() as d">
            <div class="agg" *ngIf="d.aggregate_risk_delta !== null">
              <strong>Aggregate Risk Δ:</strong>
              {{ d.aggregate_risk_old }} → {{ d.aggregate_risk_new }} (Δ {{ d.aggregate_risk_delta }})
            </div>
            <div *ngIf="d.added.length">
              <strong>Added Tasks ({{ d.added.length }}):</strong>
              <ul>
                <li *ngFor="let t of d.added">{{ t.id }} – {{ t.title }}</li>
              </ul>
            </div>
            <div *ngIf="d.removed.length">
              <strong>Removed Tasks ({{ d.removed.length }}):</strong>
              <ul>
                <li *ngFor="let t of d.removed">{{ t.id }} – {{ t.title }}</li>
              </ul>
            </div>
            <div *ngIf="d.modified.length">
              <strong>Modified Tasks ({{ d.modified.length }}):</strong>
              <ul>
                <li *ngFor="let m of d.modified">
                  <code>{{ m.id }}</code>
                  <ul>
                    <li *ngFor="let entry of m.changes | keyvalue">
                      {{ entry.key }}: {{ $any(entry.value).old }} → {{ $any(entry.value).new }}
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
            <div *ngIf="!d.added.length && !d.removed.length && !d.modified.length">No differences.</div>
          </div>
        </details>
        <div class="plan-summary" *ngIf="planSummary() as s">
          <div><strong>Tasks:</strong> {{ s.total }}</div>
          <div><strong>Avg Risk:</strong> {{ fmt(s.avgRisk) }}</div>
          <div><strong>Types:</strong> {{ s.types }}</div>
          <div><strong>High Priority:</strong> {{ s.highPrio }}</div>
          <div class="links" *ngIf="selectedProject() as p">
            <a
              target="_blank"
              [href]="'/api/projects/' + p.slug + '/runs/' + run.run_id + '/artifact/plan.json'"
              >plan.json</a
            >
            <a
              target="_blank"
              [href]="'/api/projects/' + p.slug + '/runs/' + run.run_id + '/artifact/metrics.json'"
              >metrics.json</a
            >
          </div>
        </div>
        <div *ngIf="loadingPlan()">Loading plan…</div>
        <table *ngIf="!loadingPlan() && planTasks().length" class="tasks">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Type</th>
              <th>Priority</th>
              <th>WSJF</th>
              <th>Risk</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of planTasks()">
              <td>{{ t.id }}</td>
              <td>{{ t.title }}</td>
              <td>{{ t.type }}</td>
              <td>{{ t.priority || '–' }}</td>
              <td>{{ fmt(t.wsjf_score) }}</td>
              <td>{{ fmt(t.risk_exposure) }}</td>
              <td>{{ t.status || '–' }}</td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="!loadingPlan() && !planTasks().length">No tasks produced.</div>
      </section>
      <section *ngIf="selectedRun() as run" class="chat-panel">
        <h3>Conversation</h3>
  <div class="chat-messages" #chatContainer *ngIf="!chatLoading(); else loadingChatTmpl">
          <div *ngIf="!chatMessages().length" class="empty">
            No messages yet. Ask something about this initiative.
          </div>
          <div *ngFor="let m of chatMessages()" [class]="roleClass(m)">
            <div class="bubble">
              <span class="sender">{{ m.sender }}</span>
              <div class="content">{{ m.content }}</div>
              <time>{{ m.timestamp | date: 'shortTime' }}</time>
            </div>
          </div>
        </div>
        <ng-template #loadingChatTmpl>
          <div class="empty">Loading conversation…</div>
        </ng-template>
        <form class="chat-input" (submit)="sendChat($event)">
          <div class="mode-bar">
            <button
              type="button"
              (click)="setMode('status')"
              [class.active]="chatMode() === 'status'"
            >
              Status
            </button>
            <button type="button" (click)="setMode('risk')" [class.active]="chatMode() === 'risk'">
              Risk
            </button>
            <button
              type="button"
              (click)="setMode('add_blocker')"
              [class.active]="chatMode() === 'add_blocker'"
            >
              Add Blocker
            </button>
            <button
              type="button"
              (click)="setMode('reprioritize')"
              [class.active]="chatMode() === 'reprioritize'"
            >
              Reprioritize
            </button>
            <button type="button" (click)="clearMode()" *ngIf="chatMode()">×</button>
          </div>
          <div class="mode-fields" *ngIf="chatMode() === 'add_blocker'">
            <input
              type="text"
              placeholder="Blocker description"
              [value]="blockerInput()"
              (input)="blockerInput.set($any($event.target).value)"
            />
          </div>
          <div class="mode-fields" *ngIf="chatMode() === 'reprioritize'">
            <input
              type="text"
              placeholder="Task IDs order e.g. T4 T1 T3"
              [value]="reorderInput()"
              (input)="reorderInput.set($any($event.target).value)"
            />
          </div>
          <input
            type="text"
            placeholder="Ask or refine (optional when using a mode)"
            [disabled]="chatSending()"
            [value]="chatInput()"
            (input)="chatInput.set($any($event.target).value)"
          />
          <button type="submit" [disabled]="chatSending() || (!chatInput().trim() && !chatMode())">
            {{ chatSending() ? 'Sending…' : chatMode() ? 'Execute' : 'Send' }}
          </button>
        </form>
        <div class="system-updates" *ngIf="systemUpdates().length">
          <strong>System Updates:</strong>
          <ul>
            <li *ngFor="let u of systemUpdates()">{{ u }}</li>
          </ul>
        </div>
      </section>
    </main>
  </section>
</div>
<toast-container />
